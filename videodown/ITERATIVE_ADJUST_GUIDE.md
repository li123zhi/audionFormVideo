# 🎯 迭代调整剪辑 - 按节点逐步调整

## 📋 算法说明

这是按照您指定的规则实现的精确调整算法：

### 核心规则

1. **按顺序对比** - 逐条对比新旧字幕的开始时间
2. **计算差值** - `当前开始时间 - 新开始时间`
3. **阈值判断** - 只有当 `|差值| > 0.5秒` 时才调整
4. **剪掉或增加**：
   - 差值 > 0.5秒：**在节点前剪掉差值**
   - 差值 < -0.5秒：**在节点前增加差值**（使用该节点画面）
5. **生成新视频** - 每次调整后立即生成新视频
6. **更新时间戳** - 调整后更新后续所有字幕的时间戳
7. **使用新视频** - 下次对比使用上一次调整后的视频

---

## 🔍 工作原理示例

### 假设原字幕和新字幕

```
对比1:
原字幕1: 0.700秒
新字幕1: 0.699秒
差值: 0.700 - 0.699 = 0.001秒
→ |0.001| < 0.5，不处理

对比2:
原字幕2: 2.033秒
新字幕2: 1.885秒
差值: 2.033 - 1.885 = 0.148秒
→ |0.148| < 0.5，不处理

对比3:
原字幕3: 3.200秒
新字幕3: 3.225秒
差值: 3.200 - 3.225 = -0.025秒
→ |-0.025| < 0.5，不处理

对比4:
原字幕4: 10.500秒
新字幕4: 10.266秒
差值: 10.500 - 10.266 = 0.234秒
→ |0.234| < 0.5，不处理

对比5: ⚠️ 需要调整
原字幕5: 12.433秒
新字幕5: 10.699秒
差值: 12.433 - 10.699 = 1.734秒 > 0.5
→ 在12.433秒节点前剪掉1.734秒
→ 具体操作: 保留[0-10.699秒] + [12.433秒-结束]
→ 删除[10.699-12.433秒]这段
→ 生成新视频A
→ 更新后续字幕时间戳: 所有后续时间 -1.734秒

对比6: (使用新视频A)
原字幕6(已调整): 14.866秒 (原16.600秒 - 1.734秒)
新字幕6: 14.666秒
差值: 14.866 - 14.666 = 0.200秒
→ |0.200| < 0.5，不处理

最终结果:
- 剪掉了1.734秒
- 新字幕与视频同步
```

---

## 🚀 使用方法

### 命令行使用

```bash
cd /Users/ruite_ios/Desktop/aiShortVideo/videorecomp/videodown

python test_iterative_adjust.py \
    your_video.mp4 \
    original.srt \
    new.srt
```

### 指定阈值

```bash
python test_iterative_adjust.py \
    your_video.mp4 \
    original.srt \
    new.srt \
    0.3  # 使用0.3秒作为阈值
```

---

## 📊 算法特点

### 与之前算法的区别

| 特性 | 累积调整 | 时间轴对齐 | **迭代调整** ⭐ |
|-----|---------|-----------|--------------|
| 调整方式 | 一次性计算 | 按新时间轴 | **逐步调整** |
| 视频更新 | 一次生成 | 一次生成 | **每次调整都生成新视频** |
| 时间戳更新 | 累积偏移 | 使用新时间 | **每次调整后立即更新** |
| 精确度 | 中等 | 高 | **最高** |
| 处理时间 | 快 | 中等 | **较慢** |

### 优势

✅ **精确调整** - 每个节点独立处理，精确到毫秒
✅ **逐步逼近** - 每次调整都基于上一次的结果
✅ **实时更新** - 时间戳每次调整后立即更新
✅ **可视化** - 每一步都可以看到调整效果
✅ **完全符合规则** - 严格按照您指定的规则实现

---

## 💡 处理流程

```
1. 加载原字幕和新字幕
   ↓
2. 对比第1条字幕
   - 计算: 原开始 - 新开始
   - 如果 |差值| < 0.5: 跳过
   - 如果 差值 > 0.5: 在节点前剪掉差值，生成新视频
   - 如果 差值 < -0.5: 在节点前增加差值，生成新视频
   - 更新后续字幕时间戳
   ↓
3. 对比第2条字幕 (使用新视频)
   - 重复步骤2的逻辑
   ↓
4. 对比第3条字幕 (使用更新的视频)
   ↓
... (继续处理所有字幕)
   ↓
N. 生成最终视频
```

---

## 📈 预期效果

### 视频时长

- **剪掉情况**: 视频时长减少
- **增加情况**: 视频时长增加（使用冻结帧）
- **总体**: 接近新字幕的总时长

### 同步效果

- ✅ 新字幕与视频内容完美对应
- ✅ 每个字幕节点都精确对齐
- ✅ 保持原视频的内容完整性

---

## 🔍 日志说明

### 调整日志

处理完成后会生成 `output/iterative_adjustment_log.json`：

```json
{
  "stats": {
    "original_duration": 120.5,
    "final_duration": 118.8,
    "duration_change": -1.7,
    "total_adjustments": 1,
    "total_adjustment_time": 1.734,
    "adjustment_log": [...]
  },
  "adjustments": [
    {
      "index": 5,
      "time_diff": "+1.734",
      "action": "剪掉",
      "adjustment": "剪掉1.734秒",
      "clip_point": "12.433s"
    }
  ]
}
```

### 控制台输出

```
对比1:
  当前字幕1: 0.700s - 1.866s
  新字幕1: 0.699s - 1.885s
  差值: +0.001秒
  |差值| < 0.5，不处理

对比5:
  当前字幕5: 12.433s - 13.933s
  新字幕5: 10.699s - 11.931s
  差值: +1.734秒
  差值 > 0，需要剪掉 1.734秒
  剪掉 [10.699 - 12.433] 秒，时长: 1.734秒
  ✅ 视频剪辑成功
  更新字幕5及之后的时间戳，偏移量: +1.734秒
```

---

## ⚙️ 参数调整

### 阈值设置

默认阈值是0.5秒，你可以根据需要调整：

```bash
# 使用更严格的阈值（0.3秒）
python test_iterative_adjust.py video.mp4 orig.srt new.srt 0.3

# 使用更宽松的阈值（0.8秒）
python test_iterative_adjust.py video.mp4 orig.srt new.srt 0.8
```

### 阈值选择建议

- **0.3秒** - 严格调整，几乎任何时间差都会处理
- **0.5秒** - **推荐**，平衡精确度和自然度
- **0.8秒** - 宽松调整，只处理较大的时间差

---

## 🎯 立即测试

```bash
cd /Users/ruite_ios/Desktop/aiShortVideo/videorecomp/videodown

python test_iterative_adjust.py \
    your_video.mp4 \
    original.srt \
    new.srt
```

**按节点逐步调整，每次生成新视频，精确同步！** ✨
